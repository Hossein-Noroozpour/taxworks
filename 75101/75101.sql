SELECT
	REG0.TIN, REG0.INTERNAL_ID, LETAN.CC03_ID AN,
	SUBSTR(LETAN.CC03_ENTITY_ID, 1, INSTR(LETAN.CC03_ENTITY_ID, '-') - 1) RET
FROM
	REG.TAXPAYER REG0
	JOIN STL.TC03_LETTER LETCOMP ON
		REG0.INTERNAL_ID = LETCOMP.CR01_INTERNAL_ID
		AND LETCOMP.CC01_ID = 135
	JOIN STL.TC03_LETTER LETAN ON
		LETAN.CC03_ID = LETCOMP.CC03_ENTITY_ID
		AND REG0.INTERNAL_ID = LETAN.CR01_INTERNAL_ID
		AND LETAN.CC01_ID IN ('52','54','55','56','57','58','59','104', '137')
WHERE
	NOT EXISTS (
		SELECT DISTINCT OBJ2.CA02_RETURN_ID
    	FROM
	    	OBJ.TO01_REQUESTS OBJ1
	    	JOIN OBJ.TO02_REQUEST_DETAILS OBJ2 ON OBJ1.CO01_REQUEST_NO = OBJ2.CO01_REQUEST_NO
    	WHERE
	    	OBJ1.CSTD_REQUEST_STATUS = 'OBJ_OPEN'
	    	AND OBJ2.CA02_RETURN_ID = SUBSTR(LETAN.CC03_ENTITY_ID, 1, INSTR(LETAN.CC03_ENTITY_ID, '-') - 1)
	)
	AND (
		SELECT COUNT(DISTINCT RET0.CA02_TAX_DUE)
	    FROM RET.TA02_RETURNS RET0
    	WHERE RET0.CA02_RETURN_ID = SUBSTR(LETAN.CC03_ENTITY_ID, 1, INSTR(LETAN.CC03_ENTITY_ID, '-') - 1)
	) > 1
	AND TIN IN (
		'0531222403',
		'6649743798',
		'5169748388',
		'0682636363',
		'0682163511'
	)
